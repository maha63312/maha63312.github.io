---
layout: portfolio_post
title: "Uge 44 - Kafka Producer – Publisering af RecognitionCompleted Event"
week: 44
categories: ["snippets"]
elective:
  - "Backend-udvikling og API-design"
goals: |
  Implementere en Kafka-adapter, der kan publicere events på et nyt, dedikeret topic.
  Skrive UnitTests, der kan bidrage til at kvalitetssikre driften af microservicen.
process: |
  Jeg har arbejdet ud fra Ports & Adapters (Hexagonal Architecture), hvor applikationslaget kun kommunikerer med abstraktioner (interfaces). Den konkrete Kafka implementering placeres som en adapter i Infrastruktur-laget og registreres via Dependency Injection.
result: |
  **Dependency Injection, Port og Adapter**

  Klassen `RecognitionCompletedKafkaProducer` implementerer interfacet `IRecognitionCompletedPublisher`.
  På den måde forholder applikationslaget sig kun til *en port* og kender ikke den konkrete teknologi (Kafka). Adapteren er internal sealed, da den kun skal bruges i Infrastruktur-laget og ikke nedarves.

  Denne arkitektur giver:
  - Mulighed for at skifte message broker (fx Kafka → RabbitMQ) uden at ændre domænelogik.
  - Testbarhed, da eksterne afhængigheder kan mockes.
  - Klar opdeling mellem domæne og infrastruktur (Separation of Concerns).

  ![DependencyInjection](/assets/images/DependencyInjection.png)  

  **Publicering af event (kerneflow)**

  ![KafkaProducer](/assets/images/KafkaProducer.png)  

  I publiseringsflowet mappes domænedata først til en ekstern event-kontrakt, hvorefter eventet serialiseres og sendes til det konfigurerede topic. Dermed holdes domænelag og message broker-lag adskilt.
  
  **Unit Test (Adfærdsdrevet test af publish-flow)**

  I unit testen mockes både serializer og Kafka-produceren. Dette giver en deterministisk test, hvor adfærden verificeres uden at have en kørende Kafka-broker.

  Testen verificerer:
  - at serialisering udføres én gang
  - at eventet sendes til det forventede topic
  - at key og payload stemmer overens med domænedata
  - at beskeden sendes præcis én gang for at undgå duplikering

  ![UniTestProducer](/assets/images/UniTestProducer.png)  
  
learning: |
  Jeg har lært at adskille domænelogik fra infrastruktur gennem dependency injection og port-interface design. Dette giver en fleksibel og udvidelsesvenlig arkitektur, hvor teknologivalg (som Kafka) kan ændres uden at påvirke applikationslaget.

  Jeg har samtidig styrket min evne til at skrive enhedstests, der tester den **forventede opførsel** af implementeringen
  i stedet for interne detaljer. Det gør testene robuste og fleksible, da implementationen kan refaktoreres uden at testene
  skal ændres.

  
next_plan: |
  Udvide tests med fejlscenarier (fx serialization-fejl eller broker-unavailability).
  Tilføje logging-verificering for at understøtte driftssporbarhed.
resources:
  - { title: "Implementering af Kafka – HLD og LLD", url: "https://maha63312.github.io/2025/11/01/uge44.html" }
---
